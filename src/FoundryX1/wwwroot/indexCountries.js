var country = {
    "Afghanistan": { "lat": 33.00, "lng": 65.00 },
    "Akrotiri": { "lat": 34.37, "lng": 32.58 },
    "Albania": { "lat": 41.00, "lng": 20.00 },
    "Algeria": { "lat": 28.00, "lng": 3.00 },
    "American Samoa": { "lat": -14.20, "lng": -170.00 },
    "Andorra": { "lat": 42.30, "lng": 1.30 },
    "Angola": { "lat": -12.30, "lng": 18.30 },
    "Anguilla": { "lat": 18.15, "lng": -63.10 },
    "Antarctica": { "lat": -90.00, "lng": 0.00 },
    "Antigua and Barbuda": { "lat": 17.03, "lng": -61.48 },
    "Arctic Ocean": { "lat": 90.00, "lng": 0.00 },
    "Argentina": { "lat": -34.00, "lng": -64.00 },
    "Armenia": { "lat": 40.00, "lng": 45.00 },
    "Aruba": { "lat": 12.30, "lng": -69.58 },
    "Ashmore and Cartier Islands": { "lat": -12.14, "lng": 123.05 },
    "Atlantic Ocean": { "lat": 0.00, "lng": -25.00 },
    "Australia": { "lat": -27.00, "lng": 133.00 },
    "Austria": { "lat": 47.20, "lng": 13.20 },
    "Azerbaijan": { "lat": 40.30, "lng": 47.30 },
    "Bahamas The": { "lat": 24.15, "lng": -76.00 },
    "Bahrain": { "lat": 26.00, "lng": 50.33 },
    "Bangladesh": { "lat": 24.00, "lng": 90.00 },
    "Barbados": { "lat": 13.10, "lng": -59.32 },
    "Belarus": { "lat": 53.00, "lng": 28.00 },
    "Belgium": { "lat": 50.50, "lng": 4.00 },
    "Belize": { "lat": 17.15, "lng": -88.45 },
    "Benin": { "lat": 9.30, "lng": 2.15 },
    "Bermuda": { "lat": 32.20, "lng": -64.45 },
    "Bhutan": { "lat": 27.30, "lng": 90.30 },
    "Bolivia": { "lat": -17.00, "lng": -65.00 },
    "Bosnia and Herzegovina": { "lat": 44.00, "lng": 18.00 },
    "Botswana": { "lat": -22.00, "lng": 24.00 },
    "Bouvet Island": { "lat": -54.26, "lng": 3.24 },
    "Brazil": { "lat": -10.00, "lng": -55.00 },
    "British Indian Ocean Territory": { "lat": -6.00, "lng": 71.30 },
    "British Virgin Islands": { "lat": 18.30, "lng": -64.30 },
    "Brunei": { "lat": 4.30, "lng": 114.40 },
    "Bulgaria": { "lat": 43.00, "lng": 25.00 },
    "Burkina Faso": { "lat": 13.00, "lng": -2.00 },
    "Burma": { "lat": 22.00, "lng": 98.00 },
    "Burundi": { "lat": -3.30, "lng": 30.00 },
    "Cambodia": { "lat": 13.00, "lng": 105.00 },
    "Cameroon": { "lat": 6.00, "lng": 12.00 },
    "Canada": { "lat": 60.00, "lng": -95.00 },
    "Cape Verde": { "lat": 16.00, "lng": -24.00 },
    "Cayman Islands": { "lat": 19.30, "lng": -80.30 },
    "Central African Republic": { "lat": 7.00, "lng": 21.00 },
    "Chad": { "lat": 15.00, "lng": 19.00 },
    "Chile": { "lat": -30.00, "lng": -71.00 },
    "China": { "lat": 35.00, "lng": 105.00 },
    "Christmas Island": { "lat": -10.30, "lng": 105.40 },
    "Clipperton Island": { "lat": 10.17, "lng": -109.13 },
    "Cocos Islands": { "lat": -12.30, "lng": 96.50 },
    "Colombia": { "lat": 4.00, "lng": -72.00 },
    "Comoros": { "lat": -12.10, "lng": 44.15 },
    "Democratic Republic Congo": { "lat": 0.00, "lng": 25.00 },
    "Congo Republic of the": { "lat": -1.00, "lng": 15.00 },
    "Cook Islands": { "lat": -21.14, "lng": -159.46 },
    "Coral Sea Islands": { "lat": -18.00, "lng": 152.00 },
    "Costa Rica": { "lat": 10.00, "lng": -84.00 },
    "Cote d Ivoire": { "lat": 8.00, "lng": -5.00 },
    "Croatia": { "lat": 45.10, "lng": 15.30 },
    "Cuba": { "lat": 21.30, "lng": -80.00 },
    "Curacao": { "lat": 12.10, "lng": -69.00 },
    "Cyprus": { "lat": 35.00, "lng": 33.00 },
    "Czech Republic": { "lat": 49.45, "lng": 15.30 },
    "Denmark": { "lat": 56.00, "lng": 10.00 },
    "Dhekelia": { "lat": 34.59, "lng": 33.45 },
    "Djibouti": { "lat": 11.30, "lng": 43.00 },
    "Dominica": { "lat": 15.25, "lng": -61.20 },
    "Dominican Republic": { "lat": 19.00, "lng": -70.40 },
    "Ecuador": { "lat": -2.00, "lng": -77.30 },
    "Egypt": { "lat": 27.00, "lng": 30.00 },
    "El Salvador": { "lat": 13.50, "lng": -88.55 },
    "Equatorial Guinea": { "lat": 2.00, "lng": 10.00 },
    "Eritrea": { "lat": 15.00, "lng": 39.00 },
    "Estonia": { "lat": 59.00, "lng": 26.00 },
    "Ethiopia": { "lat": 8.00, "lng": 38.00 },
    "Falkland Islands": { "lat": -51.45, "lng": -59.00 },
    "Faroe Islands": { "lat": 62.00, "lng": -7.00 },
    "Fiji": { "lat": -18.00, "lng": 175.00 },
    "Finland": { "lat": 64.00, "lng": 26.00 },
    "France": { "lat": 46.00, "lng": 2.00 },
    "French Polynesia": { "lat": -15.00, "lng": -140.00 },
    "Gabon": { "lat": -1.00, "lng": 11.45 },
    "Gambia The": { "lat": 13.28, "lng": -16.34 },
    "Gaza Strip": { "lat": 31.25, "lng": 34.20 },
    "Georgia": { "lat": 42.00, "lng": 43.30 },
    "Germany": { "lat": 51.00, "lng": 9.00 },
    "Ghana": { "lat": 8.00, "lng": -2.00 },
    "Gibraltar": { "lat": 36.08, "lng": -5.21 },
    "Greece": { "lat": 39.00, "lng": 22.00 },
    "Greenland": { "lat": 72.00, "lng": -40.00 },
    "Grenada": { "lat": 12.07, "lng": -61.40 },
    "Guam": { "lat": 13.28, "lng": 144.47 },
    "Guatemala": { "lat": 15.30, "lng": -90.15 },
    "Guernsey": { "lat": 49.28, "lng": -2.35 },
    "Guinea": { "lat": 11.00, "lng": -10.00 },
    "Guinea Bissau": { "lat": 12.00, "lng": -15.00 },
    "Guyana": { "lat": 5.00, "lng": -59.00 },
    "Haiti": { "lat": 19.00, "lng": -72.25 },
    "Heard Island and McDonald Islands": { "lat": -53.06, "lng": 72.31 },
    "Vatican City": { "lat": 41.54, "lng": 12.27 },
    "Honduras": { "lat": 15.00, "lng": -86.30 },
    "Hong Kong": { "lat": 22.15, "lng": 114.10 },
    "Hungary": { "lat": 47.00, "lng": 20.00 },
    "Iceland": { "lat": 65.00, "lng": -18.00 },
    "India": { "lat": 20.00, "lng": 77.00 },
    "Indian Ocean": { "lat": -20.00, "lng": 80.00 },
    "Indonesia": { "lat": -5.00, "lng": 120.00 },
    "Iran": { "lat": 32.00, "lng": 53.00 },
    "Iraq": { "lat": 33.00, "lng": 44.00 },
    "Ireland": { "lat": 53.00, "lng": -8.00 },
    "Isle of Man": { "lat": 54.15, "lng": -4.30 },
    "Israel": { "lat": 31.30, "lng": 34.45 },
    "Italy": { "lat": 42.50, "lng": 12.50 },
    "Jamaica": { "lat": 18.15, "lng": -77.30 },
    "Jan Mayen": { "lat": 71.00, "lng": -8.00 },
    "Japan": { "lat": 36.00, "lng": 138.00 },
    "Jersey": { "lat": 49.15, "lng": -2.10 },
    "Jordan": { "lat": 31.00, "lng": 36.00 },
    "Kazakhstan": { "lat": 48.00, "lng": 68.00 },
    "Kenya": { "lat": 1.00, "lng": 38.00 },
    "Kiribati": { "lat": 1.25, "lng": 173.00 },
    "Korea North": { "lat": 40.00, "lng": 127.00 },
    "Korea South": { "lat": 37.00, "lng": 127.30 },
    "Kosovo": { "lat": 42.35, "lng": 21.00 },
    "Kuwait": { "lat": 29.30, "lng": 45.45 },
    "Kyrgyzstan": { "lat": 41.00, "lng": 75.00 },
    "Laos": { "lat": 18.00, "lng": 105.00 },
    "Latvia": { "lat": 57.00, "lng": 25.00 },
    "Lebanon": { "lat": 33.50, "lng": 35.50 },
    "Lesotho": { "lat": -29.30, "lng": 28.30 },
    "Liberia": { "lat": 6.30, "lng": -9.30 },
    "Libya": { "lat": 25.00, "lng": 17.00 },
    "Liechtenstein": { "lat": 47.16, "lng": 9.32 },
    "Lithuania": { "lat": 56.00, "lng": 24.00 },
    "Luxembourg": { "lat": 49.45, "lng": 6.10 },
    "Macau": { "lat": 22.10, "lng": 113.33 },
    "Macedonia": { "lat": 41.50, "lng": 22.00 },
    "Madagascar": { "lat": -20.00, "lng": 47.00 },
    "Malawi": { "lat": -13.30, "lng": 34.00 },
    "Malaysia": { "lat": 2.30, "lng": 112.30 },
    "Maldives": { "lat": 3.15, "lng": 73.00 },
    "Mali": { "lat": 17.00, "lng": -4.00 },
    "Malta": { "lat": 35.50, "lng": 14.35 },
    "Marshall Islands": { "lat": 9.00, "lng": 168.00 },
    "Mauritania": { "lat": 20.00, "lng": -12.00 },
    "Mauritius": { "lat": -20.17, "lng": 57.33 },
    "Mayotte": { "lat": -12.50, "lng": 45.10 },
    "Mexico": { "lat": 23.00, "lng": -102.00 },
    "Federated States of Micronesia": { "lat": 6.55, "lng": 158.15 },
    "Moldova": { "lat": 47.00, "lng": 29.00 },
    "Monaco": { "lat": 43.44, "lng": 7.24 },
    "Mongolia": { "lat": 46.00, "lng": 105.00 },
    "Montenegro": { "lat": 42.30, "lng": 19.18 },
    "Montserrat": { "lat": 16.45, "lng": -62.12 },
    "Morocco": { "lat": 32.00, "lng": -5.00 },
    "Mozambique": { "lat": -18.15, "lng": 35.00 },
    "Namibia": { "lat": -22.00, "lng": 17.00 },
    "Nauru": { "lat": -0.32, "lng": 166.55 },
    "Navassa Island": { "lat": 18.25, "lng": -75.02 },
    "Nepal": { "lat": 28.00, "lng": 84.00 },
    "Netherlands": { "lat": 52.30, "lng": 5.45 },
    "Netherlands Antilles": { "lat": 12.12, "lng": -68.15 },
    "New Caledonia": { "lat": -21.30, "lng": 165.30 },
    "New Zealand": { "lat": -41.00, "lng": 174.00 },
    "Nicaragua": { "lat": 13.00, "lng": -85.00 },
    "Niger": { "lat": 16.00, "lng": 8.00 },
    "Nigeria": { "lat": 10.00, "lng": 8.00 },
    "Niue": { "lat": -19.02, "lng": -169.52 },
    "Norfolk Island": { "lat": -29.02, "lng": 167.57 },
    "Northern Mariana Islands": { "lat": 15.12, "lng": 145.45 },
    "Norway": { "lat": 62.00, "lng": 10.00 },
    "Oman": { "lat": 21.00, "lng": 57.00 },
    "Pacific Ocean": { "lat": 0.00, "lng": -160.00 },
    "Pakistan": { "lat": 30.00, "lng": 70.00 },
    "Palau": { "lat": 7.30, "lng": 134.30 },
    "Panama": { "lat": 9.00, "lng": -80.00 },
    "Papua New Guinea": { "lat": -6.00, "lng": 147.00 },
    "Paracel Islands": { "lat": 16.30, "lng": 112.00 },
    "Paraguay": { "lat": -23.00, "lng": -58.00 },
    "Peru": { "lat": -10.00, "lng": -76.00 },
    "Philippines": { "lat": 13.00, "lng": 122.00 },
    "Pitcairn Islands": { "lat": -25.04, "lng": -130.06 },
    "Poland": { "lat": 52.00, "lng": 20.00 },
    "Portugal": { "lat": 39.30, "lng": -8.00 },
    "Puerto Rico": { "lat": 18.15, "lng": -66.30 },
    "Qatar": { "lat": 25.30, "lng": 51.15 },
    "Romania": { "lat": 46.00, "lng": 25.00 },
    "Russia": { "lat": 60.00, "lng": 100.00 },
    "Rwanda": { "lat": -2.00, "lng": 30.00 },
    "Saint Barthelemy": { "lat": 17.90, "lng": -62.85 },
    "Saint Helena Ascension and Tristan da Cunha Saint Helena": { "lat": -15.57, "lng": -5.42 },
    "Saint Kitts and Nevis": { "lat": 17.20, "lng": -62.45 },
    "Saint Lucia": { "lat": 13.53, "lng": -60.58 },
    "Saint Martin": { "lat": 18.05, "lng": -63.57 },
    "Saint Pierre and Miquelon": { "lat": 46.50, "lng": -56.20 },
    "Saint Vincent and the Grenadines": { "lat": 13.15, "lng": -61.12 },
    "Samoa": { "lat": -13.35, "lng": -172.20 },
    "San Marino": { "lat": 43.46, "lng": 12.25 },
    "Sao Tome and Principe": { "lat": 1.00, "lng": 7.00 },
    "Saudi Arabia": { "lat": 25.00, "lng": 45.00 },
    "Senegal": { "lat": 14.00, "lng": -14.00 },
    "Serbia": { "lat": 44.00, "lng": 21.00 },
    "Seychelles": { "lat": -4.35, "lng": 55.40 },
    "Sierra Leone": { "lat": 8.30, "lng": -11.30 },
    "Singapore": { "lat": 1.22, "lng": 103.48 },
    "Sint Maarten": { "lat": 18.4, "lng": -63.4 },
    "Slovakia": { "lat": 48.40, "lng": 19.30 },
    "Slovenia": { "lat": 46.07, "lng": 14.49 },
    "Solomon Islands": { "lat": -8.00, "lng": 159.00 },
    "Somalia": { "lat": 10.00, "lng": 49.00 },
    "South Africa": { "lat": -29.00, "lng": 24.00 },
    "South Georgia and South Sandwich Islands": { "lat": -54.30, "lng": -37.00 },
    "South Sudan": { "lat": 4.51, "lng": 31.35 },
    "Southern Ocean": { "lat": -60.00, "lng": 90.00 },
    "Spain": { "lat": 40.00, "lng": -4.00 },
    "Spratly Islands": { "lat": 8.38, "lng": 111.55 },
    "Sri Lanka": { "lat": 7.00, "lng": 81.00 },
    "Sudan": { "lat": 15.00, "lng": 30.00 },
    "Suriname": { "lat": 4.00, "lng": -56.00 },
    "Svalbard": { "lat": 78.00, "lng": 20.00 },
    "Swaziland": { "lat": -26.30, "lng": 31.30 },
    "Sweden": { "lat": 62.00, "lng": 15.00 },
    "Switzerland": { "lat": 47.00, "lng": 8.00 },
    "Syria": { "lat": 35.00, "lng": 38.00 },
    "Taiwan": { "lat": 23.30, "lng": 121.00 },
    "Tajikistan": { "lat": 39.00, "lng": 71.00 },
    "Tanzania": { "lat": -6.00, "lng": 35.00 },
    "Thailand": { "lat": 15.00, "lng": 100.00 },
    "Timor Leste": { "lat": -8.50, "lng": 125.55 },
    "Togo": { "lat": 8.00, "lng": 1.10 },
    "Tokelau": { "lat": -9.00, "lng": -172.00 },
    "Tonga": { "lat": -20.00, "lng": -175.00 },
    "Trinidad and Tobago": { "lat": 11.00, "lng": -61.00 },
    "Tunisia": { "lat": 34.00, "lng": 9.00 },
    "Turkey": { "lat": 39.00, "lng": 35.00 },
    "Turkmenistan": { "lat": 40.00, "lng": 60.00 },
    "Turks and Caicos Islands": { "lat": 21.45, "lng": -71.35 },
    "Tuvalu": { "lat": -8.00, "lng": 178.00 },
    "Uganda": { "lat": 1.00, "lng": 32.00 },
    "Ukraine": { "lat": 49.00, "lng": 32.00 },
    "United Arab Emirates": { "lat": 24.00, "lng": 54.00 },
    "United Kingdom": { "lat": 54.00, "lng": -2.00 },
    "United States": { "lat": 38.00, "lng": -97.00 },
    "Uruguay": { "lat": -33.00, "lng": -56.00 },
    "Uzbekistan": { "lat": 41.00, "lng": 64.00 },
    "Vanuatu": { "lat": -16.00, "lng": 167.00 },
    "Venezuela": { "lat": 8.00, "lng": -66.00 },
    "Vietnam": { "lat": 16.10, "lng": 107.50 },
    "Virgin Islands": { "lat": 18.20, "lng": -64.50 },
    "Wake Island": { "lat": 19.17, "lng": 166.39 },
    "Wallis and Futuna": { "lat": -13.18, "lng": -176.12 },
    "West Bank": { "lat": 32.00, "lng": 35.15 },
    "Western Sahara": { "lat": 24.30, "lng": -13.00 },
    "Yemen": { "lat": 15.00, "lng": 48.00 },
    "Zambia": { "lat": -15.00, "lng": 30.00 },
    "Zimbabwe": { "lat": -20.00, "lng": 30.00 }
};

var foApp = angular.module('foApp', []);

(function (app, fo, tools, ops, undefined) {

    app.controller('workspaceController', function (dataService, ontologyLocationService, render3DService) {

        var self = this;
        var locationDB = ontologyLocationService.locationDB;
        var placeDB = ontologyLocationService.placeDB;
        var nodeDB = ontologyLocationService.nodeDB;

        self.locationDB = locationDB;
        self.placeDB = placeDB;
        self.nodeDB = nodeDB;

        var scene = render3DService.init('earth');
        render3DService.animate();
        var globe = render3DService.addGlobe();

        var EARTH_RADIUS = 637;
        var radius = EARTH_RADIUS + 20;

        self.doExport = function () {
            render3DService.export();
        }




        //function renderModel(list, modelDef) {
        //    list.forEach(function (item) {
        //        var model = modelDef.create();
        //        model.position(latLongToVector3(item.latitude, item.longitude, radius, item.currentAltitude | 0));

        //        var phi = (item.latitude) * Math.PI / 180;
        //        var theta = (item.longitude) * Math.PI / 180;

        //        model.rotateOnY(theta);
        //    });

        //}

        tools.forEachKeyValue(country,function (key, item) {
            placeDB.newInstance({
                id: key,
                name: key,
                geoLocation: locationDB.newInstance({
                    latitude: item.lat,
                    longitude: item.lng,
                })
            });
        });

        //var key = 1;
        //for (var lat = 0; lat < 1; lat += 10) {
        //    for (var lng = 0; lng <= 180; lng += 15) {
        //        placeDB.newInstance({
        //            id: key++,
        //            name: key,
        //            geoLocation: locationDB.newInstance({
        //                latitude: lat,
        //                longitude: lng,
        //            })
        //        });
        //    }
        //}

        render3DService.addLights();

        var material = {
            ambient: 0x000000,
            color: 0xff0000,
            specular: 0x999999,
            shininess: 100,
            shading: THREE.SmoothShading,
            opacity: 0.8,
            transparent: true
        };

        render3DService.loadPrimitive('block', { width: 10, height: 100, depth: 10 })
        .then(function (block) {

            placeDB.items.forEach(function (item) {
                var model = block.create();
                var geo = item.geoLocation;
                var pos = render3DService.latLongToVector3(geo.latitude, geo.longitude, EARTH_RADIUS, 50);
                model.position(pos);

                model.rotateOnY(geo.longitude * Math.PI / 180);
                model.rotateOnZ((270 + geo.latitude) * Math.PI / 180)
            });

        });

        // The deviation position of the ground from the center
        var yDeviation = 0;
        var zDeviation = 0;
        var xDeviation = 0;

        function colorLuminance(hex, lum) {

            // validate hex string
            hex = String(hex).replace(/[^0-9a-f]/gi, '');
            if (hex.length < 6) {
                hex = hex[0] + hex[0] + hex[1] + hex[1] + hex[2] + hex[2];
            }
            lum = lum || 0;

            // convert to decimal and change luminosity
            var rgb = "#", c, i;
            for (i = 0; i < 3; i++) {
                c = parseInt(hex.substr(i * 2, 2), 16);
                c = Math.round(Math.min(Math.max(0, c + (c * lum)), 255)).toString(16);
                rgb += ("00" + c).substr(c.length);
            }

            return rgb;
        }

        var ScaleText = function (text, type, pos, color, yStep) {

            // the 3D object for the text label
            this.txtobj = null;

            // type: can be "val", "col", "row"
            this.ttype = type;

            // text
            this.txt = text;

            // position
            this.position = pos;

            // the difirance in position according y axis
            this.yStep = yStep;

            // the color
            this.color = 0x555555;
            if (color) this.color = parseInt(color, 16);

            // label vars
            this.textSize = 30;
            this.textHeight = 5;
            this.textFont = "helvetiker";
            this.letterSize = 7 // this depends on the font

            // function to add the bar to the scene and position it
            this.addText = function (target) {

                // Create a three.js text geometry
                var geometry = new THREE.TextGeometry(this.txt, {
                    size: this.textSize,
                    height: this.textHeight,
                    curveSegments: 3,
                    font: this.textFont,
                    weight: "bold",
                    style: "normal",
                    bevelEnabled: false
                });

                var material = new THREE.MeshPhongMaterial({ color: this.color, shading: THREE.FlatShading });

                // Positions the text and adds it to the scene
                this.txtobj = new THREE.Mesh(geometry, material);

                if (this.ttype == "col") {
                    this.txtobj.position.x = -xDeviation + squareStep / 5;
                    this.txtobj.position.y = -zDeviation - this.position * squareStep -
                                             squareStep / 2;
                } else if (type == "row") {
                    this.txtobj.rotation.z = Math.PI / 2;
                    this.txtobj.position.x = xDeviation + this.position * squareStep +
                                             squareStep / 2;
                    this.txtobj.position.y = zDeviation - squareStep / 5 -
                                            this.txt.length *
                                            (this.textSize - this.letterSize);
                } else {
                    this.txtobj.rotation.y = Math.PI / 2;
                    this.txtobj.position.x = -zDeviation;
                    this.txtobj.position.z = squareStep / 5 +
                                              this.txt.length *
                                              (this.textSize - this.letterSize);
                    this.txtobj.position.y = yDeviation + this.position * yStep -
                                             this.textSize / 2;
                }

                target.add(this.txtobj);

            };

            // function to show the label
            this.highlightText = function () {

                if (this.hasLabel) {
                    this.labelobj.visible = true;
                }

            };

            // function to hide the label
            this.unhighlightText = function () {

                if (this.hasLabel) {
                    this.labelobj.visible = false;
                }

            };


        };

        var BarCube = function (color, x, z, val, valcolor, render, html_label, titles, minScaleVal, scaleDif, valHeight) {

            // The render type - can be light and full
            this.renderType = render;

            //the 3D cube object
            this.barobj = null;

            //the 3D stroke (wireframe object) object
            this.wfobj = null;

            // the 3D object for the text label
            this.labelobj = null

            // should we set the wireframe
            this.hasWireframe = true;

            // should it have a label. The HTML one should point to a dom element
            this.hasLabel = true;
            this.hasHTMLLabel = html_label;

            // should it cast/receive shadows
            this.hasShadows = true;

            // the square size (x and z)
            this.sqsize = 100;

            // position in the quadrant
            this.posx = x;
            this.posz = z;

            // value & height
            this.val = val;
            this.h = ((val - minScaleVal) / scaleDif) * valHeight;
            if (this.h == 0) this.h = 0.5;

            // rows and column titles
            this.titles = titles;

            // main cube colour
            this.color = parseInt(color, 16);
            this.htmlcolor = "#" + color;
            this.lumcolor = colorLuminance(color, 0.5);
            this.darklumcolor = colorLuminance(color, -0.3);
            this.valcolor = parseInt(valcolor, 16);

            // label vars
            this.labelSize = 50;
            this.labelHeight = 5;
            this.labelFont = "helvetiker";

            // function to add the bar to the scene and position it
            this.addBar = function (target) {

                // Simple cube geometry for the bar
                var geometry = new THREE.CubeGeometry(this.sqsize, this.h, this.sqsize);
                // Material for the bars with transparency
                var material = new THREE.MeshPhongMaterial({
                    ambient: 0x000000,
                    color: this.color,
                    specular: 0x999999,
                    shininess: 100,
                    shading: THREE.SmoothShading,
                    opacity: 0.8,
                    transparent: true
                });

                //  if we want a lower quality renderer - mainly with canvas renderer
                if (this.renderType == 'light') {
                    var material = new THREE.MeshLambertMaterial({
                        color: this.color,
                        shading: THREE.FlatShading,
                        overdraw: true
                    });
                    this.hasWireframe = false;
                    this.hasShadows = false;
                }

                var squareStep = 10;

                // Creating the 3D object, positioning it and adding it to the scene
                this.barobj = new THREE.Mesh(geometry, material);
                // Adds shadows if selected as an option
                if (this.hasShadows) {
                    this.barobj.castShadow = true;
                    this.barobj.receiveShadow = true;
                }
                this.barobj.position.x = xDeviation + this.posx * squareStep + squareStep / 2;
                this.barobj.position.y = yDeviation + this.h / 2;
                this.barobj.position.z = zDeviation + this.posz * squareStep + squareStep / 2;
                target.add(this.barobj);

                // If we want to have wireframe (with a lighter colour) we attach 2nd obj
                if (this.hasWireframe) {

                    // Creates cube with the same size
                    var geometry = new THREE.CubeGeometry(this.sqsize, this.h, this.sqsize);

                    // Generates a wireframe material
                    var material = new THREE.MeshBasicMaterial({
                        color: parseInt(this.lumcolor, 16),
                        wireframe: true
                    });
                    this.wfobj = new THREE.Mesh(geometry, material);
                    this.wfobj.receiveShadow = true;

                    // Adds the wireframe object to the main one
                    this.barobj.add(this.wfobj);
                }

                // If we want to have a label, we add a text object
                if (this.hasLabel) {

                    var txt = this.val.toString();
                    var curveSeg = 3;
                    var material = new THREE.MeshPhongMaterial({
                        color: this.valcolor,
                        shading: THREE.FlatShading
                    });

                    // changing to simple values if lower rendering method selected
                    if (this.renderType == 'light') {
                        curveSeg = 1;
                        material = new THREE.MeshBasicMaterial({ color: this.valcolor });
                    }

                    // Create a three.js text geometry
                    var geometry = new THREE.TextGeometry(txt, {
                        size: this.labelSize,
                        height: this.labelHeight,
                        curveSegments: curveSeg,
                        font: this.labelFont,
                        weight: "bold",
                        style: "normal",
                        bevelEnabled: false
                    });

                    // Positions the text and adds it to the scene
                    this.labelobj = new THREE.Mesh(geometry, material);
                    this.labelobj.position.y += (this.h / 2) + 50;
                    this.labelobj.position.x -= (this.labelSize * txt.length / 3);
                    this.labelobj.position.z += 50;
                    this.labelobj.rotation.y = Math.PI / 4;
                    // Adds shadows if selected as an option
                    if (this.hasShadows) {
                        this.labelobj.castShadow = true;
                        this.labelobj.receiveShadow = true;
                    }
                    this.barobj.add(this.labelobj);

                    // hides the label at the beginning
                    this.hideLabel();

                }

            };

            // function to show the label
            this.showLabel = function (posx, posy) {

                // Shows 3D label if set
                if (this.hasLabel) {
                    this.labelobj.visible = true;
                }

                // Shows HTML Label if set - uses jquery for DOM manipulation
                if (this.hasHTMLLabel) {
                    this.hasHTMLLabel.html(this.titles.row +
                                            '<p>' + this.titles.col + ': ' + val + '</p>');
                    this.hasHTMLLabel.show();
                    // Back transformation of the coordinates
                    posx = ((posx + 1) * window.innerWidth / 2);
                    posy = -((posy - 1) * window.innerHeight / 2);
                    this.hasHTMLLabel.offset({ left: posx, top: posy });
                }

            };

            // function to hide the label
            this.hideLabel = function () {

                // Hides 3D label if set
                if (this.hasLabel) {
                    this.labelobj.visible = false;
                }

                // Hides HTML Label if set - uses jquery for DOM manipulation
                if (this.hasHTMLLabel) {
                    this.hasHTMLLabel.hide();
                }

            };

            this.reposition = function (x, y, z) {
                this.barobj.position.set(x, y, z);
            }

            this.reorientation = function (x, y, z) {
                this.barobj.rotation.set(x, y, z);
            }


        };

        //now with bar cube
        var i = 0;
        //placeDB.items.forEach(function (item) {
        //    var geo = item.geoLocation;
        //    var pos = render3DService.latLongToVector3(geo.latitude, geo.longitude, EARTH_RADIUS, 50);

        //    var bar = new BarCube(0x00FF00, 0, 1, 100, 0x00FFFF, 'light', undefined, 'titles', 0, 1, 1);

        //    // removeing the 3d label
        //    bar.hasLabel = false;
        //    // making the widht of the bar smaller
        //    bar.sqsize = 10;

        //    // add dummy object along wich we can rotate the bar for the longitute
        //    bar.dummyLng = new THREE.Mesh(
        //      new THREE.PlaneGeometry(1, 1, 0, 0),
        //      new THREE.MeshLambertMaterial({ color: 0xCCCCCC }));
        //    globe.add(bar.dummyLng);

        //    // add dummy object along wich we can rotate the bar for the latitude
        //    bar.dummyLat = new THREE.Mesh(
        //      new THREE.PlaneGeometry(1, 1, 0, 0),
        //      new THREE.MeshLambertMaterial({ color: 0xCCCCCC }));
        //    bar.dummyLng.add(bar.dummyLat);

        //    // adding the bar to the scene and positioning it to the earth surface
        //    bar.addBar(bar.dummyLat);
        //    bar.reposition(0, EARTH_RADIUS + bar.h / 2, 0);
        //    // rotating the dummy object so that it snaps to the correct country
        //    bar.dummyLng.rotation.y = Math.PI + (geo.longitude).toRad();
        //    bar.dummyLat.rotation.x = Math.PI / 2 - (geo.latitude).toRad();
        //    // adding the bar to the intersection objects
        //    //intersobj[bars.length - 1] = bars[bars.length - 1].barobj;
        //    //intersobj[bars.length - 1].barid = bars.length - 1;


        //});


    });


})(foApp, Foundry, Foundry.tools,  Foundry.listOps);

